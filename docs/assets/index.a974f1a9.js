var y=Object.defineProperty;var _=(t,r,o)=>r in t?y(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o;var g=(t,r,o)=>(_(t,typeof r!="symbol"?r+"":r,o),o);(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function o(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerpolicy&&(i.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?i.credentials="include":l.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(l){if(l.ep)return;l.ep=!0;const i=o(l);fetch(l.href,i)}})();const style$1="";class Writable{constructor(r){g(this,"value");g(this,"resolved");g(this,"previous");g(this,"listeners",[]);g(this,"listeners_once",[]);this.set(r)}async set(r,o=!1){if(r instanceof Promise)return!o&&r==this.value?void 0:(this.previous=this.resolved,this.resolved=void 0,this.value=r,this.value.then(s=>{r==this.value&&(this.resolved=s,s!=this.previous&&(this.listeners.forEach(l=>l(s)),this.listeners_once.forEach(l=>l(s)),this.listeners_once=[]))}));if(!o&&r==this.resolved)return;this.value=Promise.resolve(r),this.resolved=r,this.listeners.forEach(s=>s(r)),this.listeners_once.forEach(s=>s(r)),this.listeners_once=[]}subscribe(r){this.listeners.push(r),this.resolved!=null&&r(this.resolved)}subscribeLater(r){this.listeners.push(r)}get(){return new Promise((r,o)=>{if(this.resolved!=null)return r(this.resolved);let s=l=>{r(l)};this.listeners_once.push(s)})}then(r){return this.get().then(r)}async update(r,o=!1){return this.set(await this.get().then(r),o)}map(r){let o=new Writable(new Promise(()=>{}));return this.subscribe(s=>{o.set(r(s))}),o}}class Stored extends Writable{constructor(o,s){localStorage.getItem(o)!==null&&(s=JSON.parse(localStorage.getItem(o)));super(s);g(this,"key");this.key=o,this.subscribe(l=>{localStorage.setItem(this.key,JSON.stringify(l))})}}const htmlElement=(t,r,o="",s)=>{const l=document.createElement(t);return l.innerText=r,s&&Object.entries(s).forEach(([i,a])=>{i==="parent"&&a.appendChild(l),i==="children"?a.forEach(u=>l.appendChild(u)):i==="eventListeners"?Object.entries(a).forEach(([u,h])=>{l.addEventListener(u,h)}):i==="color"||i==="background"?l.style[i]=a:i==="style"?Object.entries(a).forEach(([u,h])=>{u=u.replace(/([A-Z])/g,"-$1").toLowerCase(),l.style.setProperty(u,h)}):i==="class"?l.classList.add(...a.split(".").filter(u=>u)):l[i]=a}),l},html=(t,...r)=>{let o=[],s={};const l=i=>{if(typeof i=="string")o.push(htmlElement("span",i));else if(typeof i=="number")o.push(htmlElement("span",i.toString()));else if(i instanceof Writable){const a=span({class:"writable-container"});i.subscribe(u=>{a.innerHTML="",a.appendChild(span(u,{class:"writable-value"}))}),o.push(a)}else if(i instanceof Promise){const a=span();i.then(u=>{a.innerHTML="",a.appendChild(span(u))}),o.push(a)}else i instanceof HTMLElement?o.push(i):i instanceof Array?i.forEach(l):s={...s,...i}};for(let i of r)l(i);return htmlElement(t,"","",{...s,children:o})},newHtmlGenerator=t=>(...r)=>html(t,...r),p=newHtmlGenerator("p"),h2=newHtmlGenerator("h2"),div=newHtmlGenerator("div"),button=newHtmlGenerator("button"),span=newHtmlGenerator("span"),table=newHtmlGenerator("table"),tr=newHtmlGenerator("tr"),td=newHtmlGenerator("td"),style=(...t)=>({style:Object.assign({},...t)}),padding=t=>style({padding:t}),background=(t="var(--background)")=>style({background:t}),input=(...t)=>{const r=t.find(l=>l instanceof Writable),o=t.filter(l=>typeof l=="string").join(" "),s=html("input",...t);return r?(r.subscribe(l=>{s.value!=l.toString()&&(s.value=l.toString())}),s.onkeydown=l=>{l.key=="Enter"&&r.set(s.value)}):s.value=o,s},popup=(...t)=>{const r=div({style:{background:"var(--background)",color:"var(--color)",padding:"1em",paddingBottom:"2em",borderRadius:"1em"}},...t),o=div({style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(166, 166, 166, 0.5)",display:"flex",justifyContent:"center",alignItems:"center"}});return o.appendChild(r),document.body.appendChild(o),o.onclick=()=>{o.remove()},r.onclick=s=>{s.stopPropagation()},o},body=document.body,typ=t=>t instanceof Array?"array":t==null?"null":t==null?"undefined":t instanceof Function?"function":t instanceof HTMLElement?"htmlElement":t instanceof Object?"object":typeof t,brackets=t=>t=="array"?["[","]"]:t=="object"?["{","}"]:t=="function"?["Function(",")"]:t=="htmlElement"?["<","/>"]:["",""],preview=t=>{let r=typ(t),o=r=="array"?t.slice(0,10).toString():r=="function"?t.toString():r=="htmlElement"?t.tagName+t.textContent:r=="object"?Object.entries(t).slice(0,3).map(([l,i])=>l+": "+String(i)).join(", "):String(t);r!="string"&&(o=o.replaceAll(`
`,""));let s=span({style:{marginLeft:"0.5em"},onclick:brackets(r)[0]!=""?()=>{s.replaceWith(full_view(t))}:void 0},`${brackets(r)[0]}${o}${brackets(r)[1]}`);return s},full_view=t=>{let r=typ(t),o=brackets(r),s=div(),l=o.map(i=>p(i,{onclick:()=>{s.replaceWith(preview(t))}}));return s.replaceChildren(l[0],div({style:{paddingLeft:"1em"}},r=="array"?t.map(i=>p(preview(i))):r=="repr"?p(t.tag+"(",Object.entries(t.args).map(([i,a])=>p(i+" = ",preview(a))),")"):r=="object"?Object.entries(t).map(([i,a])=>p(i+": ",preview(a))):r=="function"?[p(t.toString()),p(button("run",{onclick:()=>{let i=div({style:{display:"flex",flexDirection:"column",gap:"0.5em"}}),a=div(),u=()=>{let f=Array.from(i.childNodes).map(c=>c.value);a.innerHTML="";let b=t(...f.map(eval));print("run result:",b),a.append(preview(b),p())},h=()=>{i.appendChild(input({onkeydown:f=>{f.key=="Enter"&&(f.metaKey?h():u())}}))};h(),popup(div(p(t.toString()),a,i))}}))]:[]),l[1]),s},termline=(t,r)=>p(span({style:{background,position:"relative",color:"#aaa",padding:"0",margin:"0"}},t),{style:{margin:".5em 1em .5em 1em",paddingBottom:"0.5em",fontFamily:"monospace",cursor:"pointer",whiteSpace:"pre-wrap",fontSize:"0.92em",borderBottom:"1px solid #aaa"}},r);let logger=null,terminal_input=null,out=[],hist=new Stored("terminal_hist",[]),inp=[];hist.subscribe(t=>inp=t);const create_terminal=()=>{let terminal=div({style:{position:"fixed",top:"0",right:"0",width:"50%",height:"100%",border:"1px solid #888",borderRadius:"1em",background:"var(--background)",overflowY:"scroll",zIndex:"1000"}}),sidemove=!1,sidebar=div({style:{height:"100%",width:"1em",position:"absolute",left:"0em",top:"0em",cursor:"ew-resize"}});sidebar.addEventListener("mousedown",t=>{sidemove=!0,t.preventDefault()});let terminal_width=new Stored("terminal_width",50);terminal_width.subscribe(t=>{terminal.style.width=Math.max(2,t)+"%"}),document.addEventListener("mousemove",t=>{sidemove&&(terminal_width.update(r=>(window.innerWidth-t.clientX)/window.innerWidth*100),t.preventDefault())}),document.addEventListener("mouseup",t=>sidemove=!1);let content=div({style:{height:"100%",width:"100%",overflowY:"scroll"}});terminal.append(sidebar,content);let showterm=new Stored("showterm",!1);showterm.subscribe(t=>terminal.style.display=t?"block":"none"),document.addEventListener("keydown",t=>{t.metaKey&&(t.key=="b"&&(showterm.update(r=>!r),t.preventDefault()),(t.key=="l"||t.key=="k")&&(logger.innerHTML="",t.preventDefault()))}),body.appendChild(terminal),logger=div();let hist_pos=0;terminal_input=input({style:{all:"unset",width:"100%",border:"none",padding:"0.5em"},placeholder:">>>",onkeydown:e=>{if(e.key=="Enter"){e.preventDefault(),e.stopPropagation();let val=terminal_input.value.trim();if(val=="")return;try{hist.update(t=>[...t,val].slice(-100)),logger.append(termline(`inp[${inp.length-1}]: `,val)),print(eval(val))}catch(t){throw logger.append(termline("error:",t.message)),t}finally{terminal_input.value=""}terminal_input.focus(),terminal_input.scrollIntoView({behavior:"instant",block:"end",inline:"nearest"})}e.key=="ArrowUp"?(hist_pos-=1,terminal_input.value=inp[Math.max(0,inp.length+hist_pos)]):hist_pos=0}}),content.append(logger,terminal_input)},print=(...t)=>{out.push(...t),logger==null&&create_terminal();const r=termline(`out[${out.length-1}]: `,t.map(preview));return logger.appendChild(r),terminal_input.scrollIntoView({block:"end"}),t[t.length-1]};let mat_size=16;const range=t=>Array.from({length:t},(r,o)=>o),randint=(t,r)=>Math.floor(Math.random()*(r-t)+.99)+t,dtype=([t,...r])=>t.split("_")[0],shape=([t,...r])=>t.split("_")[1],atom=(t,...r)=>[t,...r],fun=(t,r,...o)=>{if(o.some(l=>l==null))return null;let s=o.some(l=>shape(l)=="matrix")?"matrix":"scalar";return[`${r}_${s}`,...range(s=="matrix"?mat_size:1).map(l=>atom(t,...o.map(([i,...a])=>a[l%a.length])))]},reduce=(t,r,o,s)=>{if(s==null||shape(s)=="scalar")return null;let[l,...i]=s;return[`${o}_scalar`,i.reduce((a,u)=>atom(r,a,u),t)]},move=(t,r)=>([o,...s])=>shape([o])=="scalar"?null:[o,...range(mat_size).map(l=>{let[i,a]=[l%4+t,Math.floor(l/4)+r];return i<0||i>=4||a<0||a>=4?-1:i+a*4}).map(l=>l==-1?atom("0"):s[l])],cast=(t,r)=>t==null?null:dtype(t)==r?t:r=="block"?null:r=="boolean"?fun("($0 ? 1 : 0)","boolean",t):dtype(t)=="number"&&r=="color"?fun("($0 > 3 ? 4 : $0)","color",t):dtype(t)=="color"&&r=="number"?fun("($0 == 0 ? 0 : ($0-1) % 3 + 1)","number",t):dtype(t)=="block"&&r=="number"?fun("($0 == 0 ? 0 : (($0+2) / 3) | 0)","number",t):dtype(t)=="block"&&r=="color"?fun("($0 == 0 ? 0 : ($0-1) % 3 + 1)","color",t):null,eq=(t,r)=>t==null||r==null||dtype(t)!=dtype(r)?null:fun("($0 == $1)","boolean",t,r),add=(t,r)=>dtype(t)=="color"||dtype(r)=="color"?null:fun("($0 + $1)","number",cast(t,"number"),cast(r,"number")),mul=(t,r)=>dtype(t)=="color"||dtype(r)=="color"?null:fun("($0 * $1)","number",cast(t,"number"),cast(r,"number")),and=(t,r)=>fun("($0 && $1)","boolean",cast(t,"boolean"),cast(r,"boolean")),or=(t,r)=>fun("($0 || $1)","boolean",cast(t,"boolean"),cast(r,"boolean")),eq_poly=(t,r)=>fun(dtype(t)!=dtype(r)?"0":"($0 == $1)","boolean",t,r),sum=t=>dtype(t)=="color"?null:reduce(atom("0"),"($0 + $1)","number",cast(t,"number")),any=t=>reduce(atom("0"),"($0 || $1)","boolean",cast(t,"boolean")),all=t=>reduce(atom("1"),"($0 && $1)","boolean",cast(t,"boolean")),chain=(...t)=>{let r=()=>{let o=t.shift();if(o==null)throw new Error("No function");if(o.length==0)return o();let s=range(o.length).map(i=>r());if(s.some(i=>i==null))throw new Error("Null argument");let l=o(...s);return l==null&&print("null result",o,s),l};return r()},compile=t=>{let[r,...o]=chain(...t),s=new Map,l=([f,...b])=>{let c=JSON.stringify([f,...b]);if(s.has(c))return s.set(c,s.get(c)+1);s.set(c,1),b.forEach(l)};o.forEach(l);let i="",a=new Map,u=([f,...b])=>{let c=JSON.stringify([f,...b]);if(a.has(c))return a.get(c);let m=b.reduce((d,w,v)=>d.replaceAll(`$${v}`,u(w)),f);if(s.get(c)>2){let d=`x${a.size}`;return a.set(c,d),i+=`const ${d} = ${m};
`,d}return m},h=o.map(u).join(`,
`);return i=i+`return [${h}];`,[r,new Function("L",i)]},is_color=t=>r=>eq(r,["color_scalar",atom(t.toString())]),right=move(1,0),up=move(0,-1),left=move(-1,0),down=move(0,1);let Core={number:t=>dtype(t)=="number"?null:cast(t,"number"),color:t=>dtype(t)=="color"?null:cast(t,"color"),right,up,left,down,isred:is_color(1),isgreen:is_color(2),isblue:is_color(3),any,all,sum,not:t=>dtype(t)!="boolean"?null:fun("(!$0)","boolean",t),and,or,eq,add,mul,0:()=>["number_scalar",atom("0")],1:()=>["number_scalar",atom("1")],2:()=>["number_scalar",atom("2")],3:()=>["number_scalar",atom("3")],x:()=>["block_matrix",...range(mat_size).map(t=>atom(`L[${t}]`))]},Lang={_eq:eq_poly,...Core,next:t=>or(or(right(t),up(t)),or(left(t),down(t))),block:(t,r)=>dtype(t)!="number"||dtype(r)!="color"?null:fun("($0 == 0 ? 0 : ($0*3)-2 + $1 -1)","block",t,r),red:()=>["color_scalar",["1"]],green:()=>["color_scalar",["2"]],blue:()=>["color_scalar",["3"]]};{let t=range(10).map(l=>Int32Array.from(range(mat_size).map(i=>randint(0,9))));const[r,o]=compile("not any and color x eq color x right color x".split(" ").map(l=>Lang[l]));(()=>{let i=performance.now();for(let h=0;h<2e5;h++)o(t[h%t.length]);let u=performance.now()-i;print(`${Math.round(2e5/u)} k rules per second`)})()}const permute=(t,r)=>t.map(o=>r.map(s=>[o,s])).flat(),tensortypes=permute(["number","color","boolean","block"],["scalar","matrix"]).map(([t,r])=>`${t}_${r}`),check=t=>{const r=()=>{let o=t.shift();if(o==null||o=="*")return tensortypes;if(o.length==0)return[o()[0]];let s;if(o.length==1&&(s=r().map(l=>o([l])).filter(l=>l!=null).map(l=>l[0])),o.length==2){let[l,i]=[r(),r()];s=l.map(a=>i.map(u=>o([a],[u])).filter(u=>u!=null).map(u=>u[0])).flat()}return Array.from(new Set(s))};return r()};print("check:",check("sum blue".split(" ").map(t=>t=="*"?"*":Lang[t])));const blockSize="40px",colors=["var(--background)","red","green","#0044FF","var(--color)"],view_scalar=(t,r)=>{if(r==null)throw new Error("Null scalar");return div({style:{...r!=null?{color:colors[t=="block"?r==0?0:(r-1)%3+1:t=="boolean"?2:4],background:t=="color"?colors[r]:colors[0]}:{background:colors[0]},width:blockSize,height:blockSize,"text-align":"center","font-size":blockSize,"font-weight":"bold"}},t=="number"?r:t=="block"?Math.floor((r+2)/3):t=="boolean"?[r==0?"":"\u2713"]:"")},view_matrix=(t,r)=>div({style:{display:"flex","flex-wrap":"wrap",background:"#111",border:"1px solid #888",width:`calc(${blockSize} * 4)`}},Array.from(r).map(o=>view_scalar(t,o))),viewdata=(t,r)=>{let[o,s]=t.split("_");return s=="scalar"?div({style:{border:"1px solid #888",width:blockSize}},view_scalar(o,r[0])):view_matrix(o,r)};let n=0,fields=[[n,n,n,n,n,n,1,n,n,1,n,n,n,n,n,n],[n,n,n,n,n,4,1,n,n,n,n,n,n,n,6,n],[n,n,n,n,n,14,n,n,1,2,3,n,4,5,6,n]].map(t=>Int32Array.from(t)),newbar=(...t)=>div({tabIndex:0,style:{display:"flex",flexDirection:"row",border:".2em solid #888",padding:".2em"}},t.map(r=>blob(r))),bar=newbar();const options=Object.entries(Lang).map(([t])=>t);let command=new Writable({words:[],current_word:""}),suggestions=t=>(done(t)?options.filter(r=>Lang[r].length>0):options).filter(r=>r.startsWith(t.current_word)).filter(r=>check([...t.words,r].map(o=>Lang[o])).length>0),done=t=>t.words.length==t.words.reduce((r,o)=>r+Lang[o].length,0)+1;const blob=(t,r)=>span(t,{style:{margin:"0 0.1em",padding:"0.2em",...r}});let view_bar=t=>{let{words:r,current_word:o}=t,s=[];const l=a=>bar.append(blob(a)),i=div({style:{position:"relative",margin:"0",padding:"0",marginTop:"0.2em"}},blob(o||"",{background:"var(--color)",color:"var(--background)"}),!done(t)||o?div({style:{position:"absolute",top:"100%",left:"0",display:"flex",flexDirection:"column",zIndex:"1000",border:"1px solid #888",background:"var(--background)"}},suggestions(t).map(a=>span(a,{style:{padding:"0.2em",cursor:"pointer"},onclick:()=>add_cmd(a)}))):null);bar.innerHTML="",l("x \u2192 "),s=[],done(t)&&bar.append(i),r.forEach(a=>{if(l(a),s[s.length-1]--,Lang[a].length>0)s.push(Lang[a].length),l("(");else for(;s[s.length-1]==0;)s.pop(),l(")")}),done(t)||bar.append(i),s.reverse().forEach(a=>{range(a).forEach(()=>l("...")),l(")")})};const add_cmd=t=>{command.update(r=>({words:done(r)?[t,...r.words]:[...r.words,t],current_word:""}))};command.subscribe(t=>{view_bar(t)});document.addEventListener("keydown",t=>{if(t.key=="Backspace"){command.update(r=>t.shiftKey?{words:r.words.slice(1),current_word:r.current_word}:r.current_word.length>0?{words:r.words,current_word:""}:{words:r.words.slice(0,-1),current_word:r.current_word});return}command.update(r=>{let o=suggestions(r),s=done(r);const l=i=>{r.words=s?[i,...r.words]:[...r.words,i],r.current_word=""};if(t.key.length==1&&(t.key==" "?l(o[0]):r.current_word+=t.key),o=suggestions(r),o.length==1)l(o[0]);else if(o.length==0)r.current_word=r.current_word.slice(0,-1);else for(;;){let i=o.map(a=>a.slice(r.current_word.length,r.current_word.length+1));if(i.some(a=>a!=i[0]))break;r.current_word+=i[0]}return r},!0)});fields=[];const sample=t=>{if(t=="number")return Math.floor(Math.random()*3)+1;if(t=="color")return["red","green","blue"][Math.floor(Math.random()*3)];if(t=="boolean")return Math.random()<.5?0:1;if(t=="block")return Math.floor(Math.random()*9)+1;if(t=="direction")return["right","left","up","down"][Math.floor(Math.random()*4)]};for(let t=0;t<16;t++){let r=Int32Array.from({length:16},(o,s)=>s==t?1:0);for(let o=0;o<Math.floor(Math.random()*3)+2;o++)r[Math.floor(Math.random()*16)]=sample("block");fields.push(r)}let board=div();function play(t){let r=levels[t]();board.innerHTML="",board.append(h2(`level ${t+1}`));let o=r.split(" ").map(c=>Lang[c]),s=(c,m)=>m.map(d=>td(viewdata(c,d))),l=(c,m)=>s(c,fields.map(d=>m(d))),i=(c,...m)=>tr(td(c),...m),a=(c,m)=>{let d=tr();return m.subscribe(w=>{d.innerHTML="",d.append(td(c),...w)}),d},u=new Writable(null);command.subscribe(c=>{!done(c)||u.set(c.words.map(m=>Lang[m]))});let f=u.map(c=>[Lang.all,Lang._eq,...o,...c]).map(c=>{let[m,d]=compile(c);return fields.map(w=>d(w))});print("comp:",compile(o)[1](fields[0]));let b=f.map(c=>c.every(m=>m.every(d=>d==1)));board.append(table(i("input",...l(...compile([Lang.x]))),a("output",u.map(c=>l(...compile(c)))),i("expect",...l(...compile(o))),a("check",f.map(c=>s("boolean_scalar",c))),i("all",td(b.map(c=>view_scalar("boolean",Number(c)))))),bar,button("spoiler",{onclick:()=>popup(div(p(r)))}))}let Funs=new Map(Object.entries(Core).map(([t,r])=>[r,t])),FunSizes=new Map;Funs.forEach((t,r)=>{FunSizes.set(r.length,[...FunSizes.get(r.length)||[],t])});let levels=[()=>"number x",()=>"color x",()=>"sum x",()=>`${sample("direction")} x`,()=>"add 1 x",()=>"mul 2 x",()=>"isblue color x",()=>"isred color x",()=>"isgreen color x",()=>`eq ${sample("number")} number x`,()=>`eq ${sample("number")} number x`,()=>`any eq ${sample("color")} color x`,()=>`any eq ${sample("color")} color x`,()=>`any eq ${sample("number")} number x`,()=>`any eq ${sample("number")} number x`,()=>`any or eq ${sample("color")} color x eq ${sample("number")} number x`,()=>`any and x eq number x ${sample("number")}`,()=>`any and x ${sample("direction")} x`,()=>`any and x ${sample("direction")} x`];levels.forEach((t,r)=>{let o=t();try{compile(o.split(" ").map(s=>Lang[s]))}catch(s){throw print("error level ",r,o,s.message),print(o.split(" ").map(l=>l+" "+Lang[l].length)),s}});let level=new Stored("level",0);level.subscribe(play);const Game=div(board,button("Levels",{onclick:t=>{let r=popup(div(levels.map((o,s)=>p({onclick:l=>{level.set(s),r.remove()},style:{cursor:"pointer"}},`level ${s+1}`))))}}),button("Next",{onclick:()=>level.update(t=>Math.min(t+1,levels.length-1),!0)})),first_time=new Stored("first_time_player",!0);first_time.then(t=>{if(t){let r=popup(div(style({textAlign:"center"}),h2("Welcome to the game"),p("This game is about finding the right rule to solve the level."),p("the first levels show usage of some of the important keywords that define what a rule is."),p("later on the levels get more creative "),p("you can use the spoiler button to see the solution for the level."),p("the input row shows the data coming in."),p('the "expect" row shows what the right rule should output.'),p('the "output" row shows what your rule should output.'),p("the input bar looks like this: "),newbar("x \u2192 "),p("here you can try to enter your rule. the autocomplete is pretty agressive to prevent you from typing impossible rules."),p(button("first level",{onclick:()=>{level.set(0),r.remove()}})),p(button("ok",{onclick:()=>{r.remove()}})),p(button("dont show again",{onclick:()=>{first_time.set(!1),r.remove()}}))));r.style.zIndex="2000"}return!0});document.body.appendChild(div(padding("1em"),Game));
