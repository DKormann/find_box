var y=Object.defineProperty;var _=(t,r,o)=>r in t?y(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o;var g=(t,r,o)=>(_(t,typeof r!="symbol"?r+"":r,o),o);(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const a of l)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(l){const a={};return l.integrity&&(a.integrity=l.integrity),l.referrerpolicy&&(a.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?a.credentials="include":l.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(l){if(l.ep)return;l.ep=!0;const a=o(l);fetch(l.href,a)}})();const style$1="";class Writable{constructor(r){g(this,"value");g(this,"resolved");g(this,"previous");g(this,"listeners",[]);g(this,"listeners_once",[]);this.set(r)}async set(r,o=!1){if(r instanceof Promise)return!o&&r==this.value?void 0:(this.previous=this.resolved,this.resolved=void 0,this.value=r,this.value.then(s=>{r==this.value&&(this.resolved=s,s!=this.previous&&(this.listeners.forEach(l=>l(s)),this.listeners_once.forEach(l=>l(s)),this.listeners_once=[]))}));if(!o&&r==this.resolved)return;this.value=Promise.resolve(r),this.resolved=r,this.listeners.forEach(s=>s(r)),this.listeners_once.forEach(s=>s(r)),this.listeners_once=[]}subscribe(r){this.listeners.push(r),this.resolved!=null&&r(this.resolved)}subscribeLater(r){this.listeners.push(r)}get(){return new Promise((r,o)=>{if(this.resolved!=null)return r(this.resolved);let s=l=>{r(l)};this.listeners_once.push(s)})}then(r){return this.get().then(r)}async update(r,o=!1){return this.set(await this.get().then(r),o)}map(r){let o=new Writable(new Promise(()=>{}));return this.subscribe(s=>{o.set(r(s))}),o}}class Stored extends Writable{constructor(o,s){localStorage.getItem(o)!==null&&(s=JSON.parse(localStorage.getItem(o)));super(s);g(this,"key");this.key=o,this.subscribe(l=>{localStorage.setItem(this.key,JSON.stringify(l))})}}const htmlElement=(t,r,o="",s)=>{const l=document.createElement(t);return l.innerText=r,s&&Object.entries(s).forEach(([a,i])=>{a==="parent"&&i.appendChild(l),a==="children"?i.forEach(c=>l.appendChild(c)):a==="eventListeners"?Object.entries(i).forEach(([c,f])=>{l.addEventListener(c,f)}):a==="color"||a==="background"?l.style[a]=i:a==="style"?Object.entries(i).forEach(([c,f])=>{c=c.replace(/([A-Z])/g,"-$1").toLowerCase(),l.style.setProperty(c,f)}):a==="class"?l.classList.add(...i.split(".").filter(c=>c)):l[a]=i}),l},html=(t,...r)=>{let o=[],s={};const l=a=>{if(typeof a=="string")o.push(htmlElement("span",a));else if(typeof a=="number")o.push(htmlElement("span",a.toString()));else if(a instanceof Writable){const i=span({class:"writable-container"});a.subscribe(c=>{i.innerHTML="",i.appendChild(span(c,{class:"writable-value"}))}),o.push(i)}else if(a instanceof Promise){const i=span();a.then(c=>{i.innerHTML="",i.appendChild(span(c))}),o.push(i)}else a instanceof HTMLElement?o.push(a):a instanceof Array?a.forEach(l):s={...s,...a}};for(let a of r)l(a);return htmlElement(t,"","",{...s,children:o})},newHtmlGenerator=t=>(...r)=>html(t,...r),p=newHtmlGenerator("p"),h2=newHtmlGenerator("h2"),div=newHtmlGenerator("div"),button=newHtmlGenerator("button"),span=newHtmlGenerator("span"),table=newHtmlGenerator("table"),tr=newHtmlGenerator("tr"),td=newHtmlGenerator("td"),style=(...t)=>({style:Object.assign({},...t)}),padding=t=>style({padding:t}),background=(t="var(--background)")=>style({background:t}),input=(...t)=>{const r=t.find(l=>l instanceof Writable),o=t.filter(l=>typeof l=="string").join(" "),s=html("input",...t);return r?(r.subscribe(l=>{s.value!=l.toString()&&(s.value=l.toString())}),s.onkeydown=l=>{l.key=="Enter"&&r.set(s.value)}):s.value=o,s},popup=(...t)=>{const r=div({style:{background:"var(--background)",color:"var(--color)",padding:"1em",paddingBottom:"2em",borderRadius:"1em"}},...t),o=div({style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(166, 166, 166, 0.5)",display:"flex",justifyContent:"center",alignItems:"center"}});return o.appendChild(r),document.body.appendChild(o),o.onclick=()=>{o.remove()},r.onclick=s=>{s.stopPropagation()},o},body=document.body,typ=t=>t instanceof Array?"array":t instanceof Function?"function":t instanceof HTMLElement?"htmlElement":t instanceof Object?"object":typeof t,brackets=t=>t=="array"?["[","]"]:t=="object"?["{","}"]:t=="function"?["Function(",")"]:t=="htmlElement"?["<","/>"]:["",""],preview=t=>{let r=typ(t),o=r=="array"?t.slice(0,10).toString():r=="function"?t.toString():r=="htmlElement"?t.tagName+t.textContent:r=="object"?Object.entries(t).slice(0,3).map(([l,a])=>l+": "+String(a)).join(", "):String(t);r!="string"&&(o=o.replaceAll(`
`,""));let s=span({style:{marginLeft:"0.5em"},onclick:brackets(r)[0]!=""?()=>{s.replaceWith(full_view(t))}:void 0},`${brackets(r)[0]}${o}${brackets(r)[1]}`);return s},full_view=t=>{let r=typ(t),o=brackets(r),s=div(),l=o.map(a=>p(a,{onclick:()=>{s.replaceWith(preview(t))}}));return s.replaceChildren(l[0],div({style:{paddingLeft:"1em"}},r=="array"?t.map(a=>p(preview(a))):r=="object"?Object.entries(t).map(([a,i])=>p(a+": ",preview(i))):r=="function"?[p(t.toString()),p(button("run",{onclick:()=>{let a=div({style:{display:"flex",flexDirection:"column",gap:"0.5em"}}),i=div(),c=()=>{let h=Array.from(a.childNodes).map(v=>v.value);i.innerHTML="",i.append(p(t(...h.map(eval))))},f=()=>{a.appendChild(input({onkeydown:h=>{h.key=="Enter"&&(h.metaKey?f():c())}}))};f(),popup(div(p(t.toString()),i,a))}}))]:[]),l[1]),s},termline=t=>p(span({style:{background,position:"relative",color:"#aaa",padding:"0",margin:"0"}},`out[${out.length-1}]: `),{style:{margin:".5em 1em .5em 1em",paddingBottom:"0.5em",fontFamily:"monospace",cursor:"pointer",whiteSpace:"pre-wrap",fontSize:"0.92em",borderBottom:"1px solid #aaa"}},t);let logger=null,terminal_input=null,hist=[],out=[];const print=(...x)=>{if(out.push(...x),hist.push(...x),logger==null){let terminal=div({style:{position:"fixed",top:"0",right:"0",width:"50%",height:"100%",border:"1px solid #888",borderRadius:"1em",background,overflowY:"scroll"}}),sidemove=!1,sidebar=div({style:{height:"100%",width:"1em",position:"absolute",left:"0em",top:"0em",cursor:"ew-resize"}});sidebar.addEventListener("mousedown",t=>{sidemove=!0,t.preventDefault()});let terminal_width=new Stored("terminal_width",50);terminal_width.subscribe(t=>{terminal.style.width=Math.max(2,t)+"%"}),document.addEventListener("mousemove",t=>{sidemove&&(terminal_width.update(r=>(window.innerWidth-t.clientX)/window.innerWidth*100),t.preventDefault())}),document.addEventListener("mouseup",t=>sidemove=!1);let content=div({style:{height:"100%",width:"100%",overflowY:"scroll"}});terminal.append(sidebar,content);let showterm=new Stored("showterm",!1);showterm.subscribe(t=>terminal.style.display=t?"block":"none"),document.addEventListener("keydown",t=>{t.metaKey&&(t.key=="b"&&(showterm.update(r=>!r),t.preventDefault()),(t.key=="l"||t.key=="k")&&(logger.innerHTML="",t.preventDefault()))}),body.appendChild(terminal),logger=div(),terminal_input=input({style:{all:"unset",width:"100%",border:"none",padding:"0.5em"},placeholder:">>>",onkeydown:e=>{if(e.key=="Enter"){if(terminal_input.value.trim()=="")return;try{print(terminal_input.value),print(eval(terminal_input.value))}catch(t){print(t.message)}terminal_input.value="",terminal_input.focus(),terminal_input.scrollIntoView({behavior:"instant",block:"end",inline:"nearest"})}}}),content.append(logger,terminal_input)}const tl=termline(x.map(preview));logger.appendChild(tl),terminal_input.scrollIntoView({block:"end"})};let mat_size=16;const range=t=>Array.from({length:t},(r,o)=>o),randint=(t,r)=>Math.floor(Math.random()*(r-t)+.99)+t,SRC={tag:"tensor",data:range(mat_size).map(t=>({tag:"source",index:t})),type:"block"},cast_scalar=(t,r,o)=>{if(t==r||t=="boolean")return o;if(r=="block")return null;let s=r=="boolean"?"($0 ? 1 : 0)":t=="number"?r=="color"?"$0 > 3 ? 4 : $0":"ERR":t=="color"?r=="number"?"$0":"ERR":t=="block"?r=="number"?"($0 == 0 ? 0 : (($0+2) / 3) | 0)":r=="color"?"($0 == 0 ? 0 : ($0-1) % 3 + 1)":"ERR":"ERR";return{tag:"tensor",type:r,data:o.data.map(l=>({tag:"ALUOp",alu:s,srcs:[l]}))}},alu=(t,r)=>({tag:"ALUOp",alu:r,srcs:t}),const_=t=>({tag:"ALUOp",alu:t.toString(),srcs:[]}),scalar=(t,r)=>({tag:"tensor",type:r,data:[const_(t)]});let app=(t,r)=>{if(t.tag=="tensor")return t;let o=r[0].type,s=[];if(t.tag=="alu"){let l=t.expect==null?[...r.filter(i=>i.type!="block"),{type:"block"}][0].type:t.expect;if(r=r.map(i=>cast_scalar(i.type,l,i)),t.alu=="$0")return r[0];let a=r.some(i=>i.data.length>2);t.reduce?s=[r[0].data.slice(1).reduce((i,c)=>alu([i,c],t.alu),r[0].data[0])]:s=range(a?mat_size:1).map(i=>({tag:"ALUOp",alu:t.alu,srcs:r.map(c=>c.data[c.data.length>1?i:0])})),o=t.result}return t.tag=="move"&&(s=range(mat_size).map(t.move).map(l=>l>0?r[0].data[l]:const_(0))),{tag:"tensor",data:s,type:o}};const alufun=(t,r,...o)=>(o.length==0&&(o=["number"]),o.length==1&&(o=[o[0],o[0]]),{tag:"alu",reduce:!1,alu:r,expect:o[0],result:o[1],arity:t}),redfun=(t,r)=>({tag:"alu",reduce:!0,alu:t,expect:r,result:r,arity:1}),arity=t=>t.tag=="alu"?t.arity:t.tag=="tensor"?0:1,move_dir=(t,r)=>({tag:"move",move:o=>{let s=o%4+t,l=Math.floor(o/4)+r;return s<0||s>3||l<0||l>3?-1:s+l*4}}),chain=(...t)=>{let r=()=>{let o=t.shift();if(o.tag=="tensor")return o;if(o==null)throw new Error("No function");let s=o.tag=="alu"?o.arity:1,l=range(s).map(a=>r());return app(o,l)};return r()},compile=t=>{let r=chain(...t),o=[],s=new Map,l=u=>{let d="";return u.tag=="source"?d=`s${u.index}`:(u.srcs=u.srcs.map(l),d=`${u.alu}(${u.srcs.map(m=>o.indexOf(m)).join(",")})`),s.has(d)?o[s.get(d)]:(s.set(d,o.length),o.push(u),u)};r.data.forEach(l);let a=new Map,i=u=>{u.tag=="ALUOp"&&u.srcs.forEach(i),a.set(u,(a.get(u)||0)+1)};r.data.forEach(i);let c="",f=new Map,h=u=>{if(f.has(u))return f.get(u);let d=u.tag=="source"?`L[${u.index}]`:u.srcs.reduce((m,b,w)=>m.replaceAll(`$${w}`,h(b)),u.alu);if(a.get(u)>0){let m=`x${f.size}`;return f.set(u,m),c+=`const ${m} = ${d};
`,m}return d},v=r.data.map(h).join(`,
`);return c=c+`return [${v}];`,[r.type,r.data.length==1?"scalar":"matrix",new Function("L",c)]},is_color=t=>alufun(1,`($0 == ${t})`,"color","boolean");let Core={number:alufun(1,"$0","number"),isred:is_color(1),isgreen:is_color(2),isblue:is_color(3),any:redfun("($0 || $1)","boolean"),sum:redfun("($0 + $1)","number"),not:alufun(1,"(!$0)","boolean"),and:alufun(2,"($0 && $1)","boolean"),eq:alufun(2,"($0 == $1)",null,"boolean"),add:alufun(2,"($0 + $1)","number","number"),0:scalar(0,"number"),1:scalar(1,"number"),2:scalar(2,"number"),3:scalar(3,"number"),x:SRC},Lang={...Core,right:move_dir(1,0),up:move_dir(0,-1),left:move_dir(-1,0),down:move_dir(0,1),color:alufun(1,"$0","color"),block:alufun(2,"$0 == 0 ? 0 : ($0*3)-2 + $1 -1","number","block"),asblock:alufun(1,"$0","block"),all:redfun("($0 && $1)","boolean"),product:redfun("($0 * $1 | 0)","number"),or:alufun(2,"($0 || $1)","boolean"),mul:alufun(2,"$0 * $1","number","number"),red:scalar(1,"color"),green:scalar(2,"color"),blue:scalar(3,"color")};{range(10).map(r=>Int32Array.from(range(mat_size).map(o=>randint(0,9))));const t="not any and color x eq color x right color x".split(" ").map(r=>Lang[r]);compile(t)}const blockSize="40px",colors=["var(--background)","red","green","#0044FF","var(--color)"],view_scalar=(t,r)=>{if(r==null)throw new Error("Null scalar");return div({style:{...r!=null?{color:colors[t=="block"?r==0?0:(r-1)%3+1:t=="boolean"?2:4],background:t=="color"?colors[r]:colors[0]}:{background:colors[0]},width:blockSize,height:blockSize,"text-align":"center","font-size":blockSize,"font-weight":"bold"}},t=="number"?r:t=="block"?Math.floor((r+2)/3):t=="boolean"?[r==0?"":"\u2713"]:"")},view_matrix=(t,r)=>div({style:{display:"flex","flex-wrap":"wrap",background:"#111",border:"1px solid #888",width:`calc(${blockSize} * 4)`}},Array.from(r).map(o=>view_scalar(t,o))),viewdata=(t,r,o)=>r=="scalar"?div({style:{border:"1px solid #888",width:blockSize}},view_scalar(t,o[0])):view_matrix(t,o);let n=0,fields=[[n,n,n,n,n,n,1,n,n,1,n,n,n,n,n,n],[n,n,n,n,n,4,1,n,n,n,n,n,n,n,6,n],[n,n,n,n,n,14,n,n,1,2,3,n,4,5,6,n]].map(t=>Int32Array.from(t)),newbar=(...t)=>div({tabIndex:0,style:{display:"flex",flexDirection:"row",border:".2em solid #888",padding:".2em"}},t.map(r=>blob(r))),bar=newbar();const options=Object.entries(Lang).map(([t])=>t);let command=new Writable({words:[],current_word:""}),suggestions=t=>(done(t)?options.filter(r=>arity(Lang[r])>0):options).filter(r=>r.startsWith(t.current_word)),done=t=>t.words.length==t.words.reduce((r,o)=>r+arity(Lang[o]),0)+1;const blob=(t,r)=>span(t,{style:{margin:"0 0.1em",padding:"0.2em",...r}});let view_bar=t=>{let{words:r,current_word:o}=t,s=[];const l=i=>bar.append(blob(i)),a=div({style:{position:"relative",margin:"0",padding:"0",marginTop:"0.2em"}},blob(o||"",{background:"var(--color)",color:"var(--background)"}),!done(t)||o?div({style:{position:"absolute",top:"100%",left:"0",display:"flex",flexDirection:"column",zIndex:"1000",border:"1px solid #888",background:"var(--background)"}},suggestions(t).map(i=>span(i,{style:{padding:"0.2em",cursor:"pointer"},onclick:()=>add_cmd(i)}))):null);bar.innerHTML="",l("x \u2192 "),s=[],done(t)&&bar.append(a),r.forEach(i=>{if(l(i),s[s.length-1]--,arity(Lang[i])>0)s.push(arity(Lang[i])),l("(");else for(;s[s.length-1]==0;)s.pop(),l(")")}),done(t)||bar.append(a),s.reverse().forEach(i=>{range(i).forEach(()=>l("...")),l(")")})};const add_cmd=t=>{command.update(r=>({words:done(r)?[t,...r.words]:[...r.words,t],current_word:""}))};command.subscribe(t=>{view_bar(t)});document.addEventListener("keydown",t=>{if(t.key=="Backspace"){command.update(r=>t.shiftKey?{words:r.words.slice(1),current_word:r.current_word}:r.current_word.length>0?{words:r.words,current_word:""}:{words:r.words.slice(0,-1),current_word:r.current_word});return}command.update(r=>{let o=suggestions(r),s=done(r);const l=a=>{r.words=s?[a,...r.words]:[...r.words,a],r.current_word=""};if(t.key.length==1&&(t.key==" "?l(o[0]):r.current_word+=t.key),o=suggestions(r),o.length==1)l(o[0]);else if(o.length==0)r.current_word=r.current_word.slice(0,-1);else for(;;){let a=o.map(i=>i.slice(r.current_word.length,r.current_word.length+1));if(a.some(i=>i!=a[0]))break;r.current_word+=a[0]}return r},!0)});fields=[];const sample=t=>{if(t=="number")return Math.floor(Math.random()*3)+1;if(t=="color")return["red","green","blue"][Math.floor(Math.random()*3)];if(t=="boolean")return Math.random()<.5?0:1;if(t=="block")return Math.floor(Math.random()*9)+1;if(t=="direction")return["right","left","up","down"][Math.floor(Math.random()*4)]};for(let t=0;t<16;t++){let r=Int32Array.from({length:16},(o,s)=>s==t?1:0);for(let o=0;o<Math.floor(Math.random()*3)+2;o++)r[Math.floor(Math.random()*16)]=sample("block");fields.push(r)}let board=div();function play(t){let r=levels[t]();board.innerHTML="",board.append(h2(`level ${t+1}`));let o=r.split(" ").map(u=>Lang[u]),s=(u,d,m)=>m.map(b=>td(viewdata(u,d,b))),l=(u,d,m)=>s(u,d,fields.map(b=>m(b))),a=(u,...d)=>tr(td(u),...d),i=(u,d)=>{let m=tr();return d.subscribe(b=>{m.innerHTML="",m.append(td(u),...b)}),m},c=new Writable(null);command.subscribe(u=>{!done(u)||c.set(u.words.map(d=>Lang[d]))});let h=c.map(u=>[Lang.all,Lang.eq,...o,...u]).map(u=>{let[d,m,b]=compile(u);return fields.map(w=>b(w))});print("comp:",compile(o)[2](fields[0]));let v=h.map(u=>u.every(d=>d.every(m=>m==1)));board.append(table(a("input",...l(...compile([Lang.x]))),i("output",c.map(u=>l(...compile(u)))),a("expect",...l(...compile(o))),i("check",h.map(u=>s("boolean","scalar",u))),a("all",td(v.map(u=>view_scalar("boolean",Number(u)))))),bar,button("spoiler",{onclick:()=>popup(div(p(r)))}))}let Funs=new Map(Object.entries(Core).map(([t,r])=>[r,t])),FunSizes=new Map;Funs.forEach((t,r)=>{FunSizes.set(arity(r),[...FunSizes.get(arity(r))||[],t])});const sample_word=t=>FunSizes.get(t)[Math.floor(Math.random()*FunSizes.get(t).length)],_sample_rule=t=>{if(Math.random()<.1&&t--,t<2)return[sample_word(0)];if(t==2)return[sample_word(1),sample_word(0)];if(Math.random()<.6)return[sample_word(1),..._sample_rule(t-1)];let r=randint(1,t-2),o=t-1-r;return[sample_word(2),..._sample_rule(r),..._sample_rule(o)]},sample_rule=t=>{let r=["any",..._sample_rule(t)],[o,s,l]=compile(r.map(i=>Lang[i])),a=fields.map(i=>l(i)[0]);return a.some(i=>i!=a[0])?r:sample_rule(t)};let levels=[()=>"number x",()=>"color x",()=>"sum x",()=>`${sample("direction")} x`,()=>"add 1 x",()=>"mul 2 x",()=>"isblue color x",()=>"isred color x",()=>"isgreen color x",()=>`eq ${sample("number")} number x`,()=>`eq ${sample("number")} number x`,()=>`any eq ${sample("color")} color x`,()=>`any eq ${sample("color")} color x`,()=>`any eq ${sample("number")} number x`,()=>`any eq ${sample("number")} number x`,()=>`any or eq ${sample("color")} color x eq ${sample("number")} number x`,()=>`any and x eq number x ${sample("number")}`,()=>`any and x ${sample("direction")} x`,()=>sample_rule(6).join(" ")];levels.forEach(t=>{try{compile(t().split(" ").map(r=>Lang[r]))}catch(r){print("error",t,r.message)}});let level=new Stored("level",0);level.subscribe(play);const Game=div(board,button("Levels",{onclick:t=>{let r=popup(div(levels.map((o,s)=>p({onclick:l=>{level.set(s),r.remove()},style:{cursor:"pointer"}},`level ${s+1}`)),p("random",{onclick:()=>{level.set(levels.length-1,!0),r.remove()},style:{cursor:"pointer"}})))}}),button("Next",{onclick:()=>level.update(t=>Math.min(t+1,levels.length-1),!0)})),first_time=new Stored("first_time_player",!0);first_time.then(t=>{if(t){let r=popup(div(style({textAlign:"center"}),h2("Welcome to the game"),p("This game is about finding the right rule to solve the level."),p("the first levels show usage of some of the important keywords that define what a rule is."),p("later on the levels get more creative "),p("you can use the spoiler button to see the solution for the level."),p("the input row shows the data coming in."),p('the "expect" row shows what the right rule should output.'),p('the "output" row shows what your rule should output.'),p("the input bar looks like this: "),newbar("x \u2192 "),p("here you can try to enter your rule. the autocomplete is pretty agressive to prevent you from typing impossible rules."),p(button("first level",{onclick:()=>{level.set(0),r.remove()}})),p(button("ok",{onclick:()=>{r.remove()}})),p(button("dont show again",{onclick:()=>{first_time.set(!1),r.remove()}}))));r.style.zIndex="2000"}return!0});document.body.appendChild(div(padding("1em"),Game));
