var w=Object.defineProperty;var _=(t,r,o)=>r in t?w(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o;var b=(t,r,o)=>(_(t,typeof r!="symbol"?r+"":r,o),o);(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}})();const style="";class Writable{constructor(r){b(this,"value");b(this,"resolved");b(this,"previous");b(this,"listeners",[]);b(this,"listeners_once",[]);this.set(r)}async set(r,o=!1){if(r instanceof Promise)return!o&&r==this.value?void 0:(this.previous=this.resolved,this.resolved=void 0,this.value=r,this.value.then(s=>{r==this.value&&(this.resolved=s,s!=this.previous&&(this.listeners.forEach(i=>i(s)),this.listeners_once.forEach(i=>i(s)),this.listeners_once=[]))}));if(!o&&r==this.resolved)return;this.value=Promise.resolve(r),this.resolved=r,this.listeners.forEach(s=>s(r)),this.listeners_once.forEach(s=>s(r)),this.listeners_once=[]}subscribe(r){this.listeners.push(r),this.resolved!=null&&r(this.resolved)}subscribeLater(r){this.listeners.push(r)}get(){return new Promise((r,o)=>{if(this.resolved!=null)return r(this.resolved);let s=i=>{r(i)};this.listeners_once.push(s)})}then(r){return this.get().then(r)}async update(r,o=!1){return this.set(await this.get().then(r),o)}map(r){let o=new Writable(new Promise(()=>{}));return this.subscribe(s=>{o.set(r(s))}),o}}class Stored extends Writable{constructor(o,s){localStorage.getItem(o)!==null&&(s=JSON.parse(localStorage.getItem(o)));super(s);b(this,"key");this.key=o,this.subscribe(i=>{localStorage.setItem(this.key,JSON.stringify(i))})}}const htmlElement=(t,r,o="",s)=>{const i=document.createElement(t);return i.innerText=r,s&&Object.entries(s).forEach(([l,a])=>{l==="parent"&&a.appendChild(i),l==="children"?a.forEach(d=>i.appendChild(d)):l==="eventListeners"?Object.entries(a).forEach(([d,f])=>{i.addEventListener(d,f)}):l==="color"||l==="background"?i.style[l]=a:l==="style"?Object.entries(a).forEach(([d,f])=>{d=d.replace(/([A-Z])/g,"-$1").toLowerCase(),i.style.setProperty(d,f)}):l==="class"?i.classList.add(...a.split(".").filter(d=>d)):i[l]=a}),i},html=(t,...r)=>{let o=[],s={};const i=l=>{if(typeof l=="string")o.push(htmlElement("span",l));else if(typeof l=="number")o.push(htmlElement("span",l.toString()));else if(l instanceof Writable){const a=span({class:"writable-container"});l.subscribe(d=>{a.innerHTML="",a.appendChild(span(d,{class:"writable-value"}))}),o.push(a)}else if(l instanceof Promise){const a=span();l.then(d=>{a.innerHTML="",a.appendChild(span(d))}),o.push(a)}else l instanceof HTMLElement?o.push(l):l instanceof Array?l.forEach(i):s={...s,...l}};for(let l of r)i(l);return htmlElement(t,"","",{...s,children:o})},newHtmlGenerator=t=>(...r)=>html(t,...r),p=newHtmlGenerator("p"),div=newHtmlGenerator("div"),button=newHtmlGenerator("button"),span=newHtmlGenerator("span"),background="var(--background)",input=(...t)=>{const r=t.find(i=>i instanceof Writable),o=t.filter(i=>typeof i=="string").join(" "),s=html("input",...t);return r?(r.subscribe(i=>{s.value!=i.toString()&&(s.value=i.toString())}),s.onkeydown=i=>{i.key=="Enter"&&r.set(s.value)}):s.value=o,s},popup=(...t)=>{const r=div({style:{background:"var(--background)",color:"var(--color)",padding:"1em",paddingBottom:"2em",borderRadius:"1em"}},...t),o=div({style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(166, 166, 166, 0.5)",display:"flex",justifyContent:"center",alignItems:"center"}});return o.appendChild(r),document.body.appendChild(o),o.onclick=()=>{o.remove()},r.onclick=s=>{s.stopPropagation()},o},body=document.body,typ=t=>t instanceof Array?"array":t instanceof Function?"function":t instanceof HTMLElement?"htmlElement":t instanceof Object?"object":typeof t,brackets=t=>t=="array"?["[","]"]:t=="object"?["{","}"]:t=="function"?["Function(",")"]:t=="htmlElement"?["<","/>"]:["",""],preview=t=>{let r=typ(t),o=r=="array"?t.slice(0,10).toString():r=="function"?t.toString():r=="htmlElement"?t.tagName+t.textContent:r=="object"?Object.entries(t).slice(0,3).map(([i,l])=>i+": "+String(l)).join(", "):String(t);r!="string"&&(o=o.replaceAll(`
`,""));let s=span({onclick:brackets(r)[0]!=""?()=>{s.replaceWith(full_view(t))}:void 0},`${brackets(r)[0]}${o}${brackets(r)[1]}`);return s},full_view=t=>{let r=typ(t),o=brackets(r),s=div(),i=o.map(l=>p(l,{onclick:()=>{s.replaceWith(preview(t))}}));return s.replaceChildren(i[0],div({style:{paddingLeft:"1em"}},r=="array"?t.map(l=>p(preview(l))):r=="object"?Object.entries(t).map(([l,a])=>p(l+": ",preview(a))):r=="function"?[p(t.toString()),p(button("run",{onclick:()=>{let l=div({style:{display:"flex",flexDirection:"column",gap:"0.5em"}}),a=div(),d=()=>{let g=Array.from(l.childNodes).map(v=>v.value);a.innerHTML="",a.append(p(t(...g.map(eval))))},f=()=>{l.appendChild(input({onkeydown:g=>{g.key=="Enter"&&(g.metaKey?f():d())}}))};f(),popup(div(p(t.toString()),a,l))}}))]:[]),i[1]),s},termline=t=>p(span({style:{background,position:"relative",color:"#aaa",padding:"0",margin:"0"}},`out[${out.length-1}]: `),{style:{margin:".5em 1em .5em 1em",paddingBottom:"0.5em",fontFamily:"monospace",cursor:"pointer",whiteSpace:"pre-wrap",fontSize:"0.92em",borderBottom:"1px solid #aaa"}},t);let logger=null,terminal_input=null,hist=[],out=[];const print=(...x)=>{if(out.push(...x),hist.push(...x),logger==null){let terminal=div({style:{position:"fixed",top:"0",right:"0",width:"50%",height:"100%",border:"1px solid #888",borderRadius:"1em",background,overflowY:"scroll"}}),sidemove=!1,sidebar=div({style:{height:"100%",width:"1em",position:"absolute",left:"0em",top:"0em",cursor:"ew-resize"}});sidebar.addEventListener("mousedown",t=>{sidemove=!0,t.preventDefault()});let terminal_width=new Stored("terminal_width",50);terminal_width.subscribe(t=>{terminal.style.width=Math.max(2,t)+"%"}),body.addEventListener("mousemove",t=>{sidemove&&(terminal_width.update(r=>(window.innerWidth-t.clientX)/window.innerWidth*100),t.preventDefault())}),body.addEventListener("mouseup",t=>sidemove=!1);let content=div({style:{height:"100%",width:"100%",overflowY:"scroll"}});terminal.append(sidebar,content);let showterm=new Stored("showterm",!1);showterm.subscribe(t=>terminal.style.display=t?"block":"none"),document.addEventListener("keydown",t=>{t.metaKey&&(t.key=="b"&&(showterm.update(r=>!r),t.preventDefault()),(t.key=="l"||t.key=="k")&&(logger.innerHTML="",t.preventDefault()))}),body.appendChild(terminal),logger=div(),terminal_input=input({style:{all:"unset",width:"100%",border:"none",padding:"0.5em"},placeholder:">>>",onkeydown:e=>{if(e.key=="Enter"){if(terminal_input.value.trim()=="")return;try{print(terminal_input.value),print(eval(terminal_input.value))}catch(t){print(t.message)}terminal_input.value="",terminal_input.focus(),terminal_input.scrollIntoView({behavior:"instant",block:"end",inline:"nearest"})}}}),content.append(logger,terminal_input)}const tl=termline(x.map(preview));logger.appendChild(tl),terminal_input.scrollIntoView({block:"end"})},doc=div({class:"document",style:{padding:"1em",width:"100%","font-family":"sans-serif"}});document.body.style.paddingBottom="200px";document.body.appendChild(doc);function put(...t){return t.forEach(r=>doc.append(r)),t[0]}const blockSize="40px",colors=["var(--background)","red","green","#0044FF","var(--color)"],view_scalar=(t,r)=>{if(r==null)throw new Error("Null scalar");return div({style:{...r!=null?{color:colors[t=="block"?r==0?0:(r-1)%3+1:t=="boolean"?2:4],background:t=="color"?colors[r]:colors[0]}:{background:colors[0]},width:blockSize,height:blockSize,"text-align":"center","font-size":blockSize,"font-weight":"bold"}},t=="number"?r:t=="block"?r==0?"":Math.floor((r-1)/3):t=="boolean"?[r==0?"":"\u2713"]:"")},view_matrix=(t,r)=>div({style:{display:"flex","flex-wrap":"wrap",background:"#111",border:"1px solid #888",width:`calc(${blockSize} * 4)`}},Array.from(r).map(o=>view_scalar(t,o)));let mat_size=16;const range=t=>Array.from({length:t},(r,o)=>o),SRC={tag:"tensor",data:range(mat_size).map(t=>({tag:"source",index:t})),type:"block"},cast_scalar=(t,r,o)=>{if(t==r||t=="boolean")return o;let s=r=="boolean"?"($0 ? 1 : 0)":t=="number"?r=="color"?"($0 % 3)":r=="block"?"($0 * 3)":"ERR":t=="color"?r=="number"?"($0 % 3)":r=="block"?"($0 * 3)":"ERR":t=="block"?r=="number"?"($0 == 0 ? 0 : ($0+2) / 3) | 0":r=="color"?"($0 == 0 ? 0 : ($0-1) % 3 + 1)":"ERR":"ERR";return{tag:"tensor",type:r,data:o.data.map(i=>({tag:"ALUOp",alu:s,srcs:[i]}))}},alu=(t,r)=>({tag:"ALUOp",alu:r,srcs:t}),const_=t=>({tag:"ALUOp",alu:t.toString(),srcs:[]});let app=(t,r)=>{if(t.tag=="tensor")return t;let o=r[0].type,s=[];if(t.tag=="alu"){if(r=r.map(l=>cast_scalar(l.type,t.expect,l)),t.alu=="$0")return r[0];let i=r.some(l=>l.data.length>2);s=range(i?mat_size:1).map(l=>({tag:"ALUOp",alu:t.alu,srcs:r.map(a=>a.data[a.data.length>1?l:0])})),o=t.result}return t.tag=="reduce"&&(s=[r[0].data.slice(1).reduce((i,l)=>alu([i,l],t.alu),r[0].data[0])]),t.tag=="move"&&(s=range(mat_size).map(t.move).map(i=>i>0?r[0].data[i]:const_(0))),{tag:"tensor",data:s,type:o}};const alufun=(t,r,...o)=>(o.length==0&&(o=["number"]),o.length==1&&(o=[o[0],o[0]]),{tag:"alu",alu:r,expect:o[0],result:o[1],arity:t}),redfun=t=>({tag:"reduce",alu:t}),arity=t=>t.tag=="alu"?t.arity:t.tag=="tensor"?0:1,move_dir=(t,r)=>({tag:"move",move:o=>{let s=o%4+t,i=Math.floor(o/4)+r;return s<0||s>3||i<0||i>3?-1:s+i*4}}),right=move_dir(1,0),left=move_dir(-1,0),up=move_dir(0,-1),down=move_dir(0,1),add=alufun(2,"($0 + $1)","number","number","number"),not=alufun(1,"(!$0)","boolean"),any=redfun("($0 || $1)"),and=alufun(2,"($0 && $1)","boolean"),eq=alufun(2,"($0 == $1)","block","boolean"),get_color=alufun(1,"$0","color"),get_value=alufun(1,"$0","number"),chain=(...t)=>{let r=()=>{let o=t.shift();if(o.tag=="tensor")return o;if(o==null)throw new Error("No function");let s=o.tag=="alu"?o.arity:1,i=range(s).map(l=>r());return app(o,i)};return r()},compile=t=>{let r=chain(...t),o=[],s=new Map,i=c=>{let u="";return c.tag=="source"?u=`s${c.index}`:(c.srcs=c.srcs.map(i),u=`${c.alu}(${c.srcs.map(h=>o.indexOf(h)).join(",")})`),s.has(u)?o[s.get(u)]:(s.set(u,o.length),o.push(c),c)};r.data.forEach(i);let l=new Map,a=c=>{c.tag=="ALUOp"&&c.srcs.forEach(a),l.set(c,(l.get(c)||0)+1)};r.data.forEach(a);let d="",f=new Map,g=c=>{if(f.has(c))return f.get(c);let u=c.tag=="source"?`L[${c.index}]`:c.srcs.reduce((h,m,y)=>h.replaceAll(`$${y}`,g(m)),c.alu);if(l.get(c)>1){let h=`x${f.size}`;return f.set(c,h),d+=`const ${h} = ${u};
`,h}return u},v=r.data.map(g).join(`,
`);return d=d+`return [${v}];`,[r.type,r.data.length==1?"scalar":"matrix",new Function("L",d)]};compile([add,SRC,SRC]);const viewdata=(t,r,o)=>r=="scalar"?div({style:{border:"1px solid #888",width:blockSize}},view_scalar(t,o[0])):view_matrix(t,o);let n=0,fields=[[n,n,n,n,n,n,1,n,n,1,n,n,n,n,n,n],[n,n,n,n,n,4,1,n,n,n,n,n,n,n,6,n],[n,n,n,n,n,14,n,n,1,2,n,n,n,n,n,n]].map(t=>Int32Array.from(t));const view_rule=t=>{let[r,o,s]=compile(t);return put(p({style:{display:"flex","flex-wrap":"wrap"}},fields.map(i=>viewdata(r,o,s(i)))))},rule=[not,any,and,get_color,SRC,eq,get_color,SRC,right,get_color,SRC],is_color=t=>({tag:"alu",alu:`($0 == ${t})`,expect:"color",result:"boolean",arity:1}),isred=is_color(1),isgreen=is_color(2),isblue=is_color(3);compile(rule);view_rule([SRC]);{let t=div({tabIndex:0,style:{display:"flex",flexDirection:"row",border:".2em solid #888",padding:".2em"}});t.focus();let r={right,left,up,down,src:SRC,eq,get_color,isred,isgreen,isblue,any,and,not,get_value,add},o=[],s="";const i=Object.entries(r).map(([c])=>c);let l=i,a=[],d=!0,f=div(),g=()=>{const c=(m,y)=>span(m,y,{style:{margin:"0 0.1em",padding:"0.2em",borderRadius:"0.2em"}});let u=c(s);u.style.background="var(--color)",u.style.color="var(--background)",t.innerHTML="",t.append(c("(")),a=[1],o.forEach(m=>{if(print(m),t.append(c(m)),a[a.length-1]--,arity(r[m])>0)a.push(arity(r[m])),t.append(c("("));else for(;a[a.length-1]==0;)a.pop(),t.append(c(")"));print(a)}),d=a.reduce((m,y)=>m+y,0)>0;let h=div({style:{position:"relative",margin:"0",padding:"0",marginTop:"0.2em"}},u,d?div({style:{position:"absolute",top:"100%",left:"0",display:"flex",flexDirection:"column",zIndex:"1000",border:"1px solid #888",background:"var(--background)"}},l.map(m=>span(m,{style:{padding:"0.2em",cursor:"pointer"}}))):null);for(t.append(h),a[a.length-1]--;a.length>0;)range(a.pop()).forEach(()=>t.append(c("..."))),t.append(c(")"));t.focus(),f.remove(),d||(f=view_rule([...o.map(m=>r[m])]))};g();const v=c=>{o.push(c),s="",l=i};t.addEventListener("keydown",c=>{for(c.key=="ArrowRight",c.key=="ArrowLeft",c.key=="Backspace"&&(s.length>0?s="":o.pop()),c.key==" "?v(l[0]):c.key.length==1&&d&&(s+=c.key),l=i.filter(u=>u.startsWith(s)),l.length==1&&v(l[0]),l.length==0&&(s=s.slice(0,-1),l=i);;){let u=l.map(h=>h.slice(s.length,s.length+1));if(u.some(h=>h!=u[0]))break;s+=u[0]}g()}),put(t),t.focus()}
